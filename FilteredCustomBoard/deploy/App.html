<!DOCTYPE html>
<html>
<head>
    <title>Custom Board</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.common.RowSettingsField",{alias:"widget.rowsettingsfield",extend:"Ext.form.FieldContainer",requires:["Rally.ui.CheckboxField","Rally.ui.combobox.ComboBox","Rally.ui.plugin.FieldValidationUi","Rally.data.ModelFactory","Rally.data.wsapi.ModelBuilder"],mixins:{field:"Ext.form.field.Field"},layout:"hbox",cls:"row-settings",config:{value:void 0,isAllowedFieldFn:Ext.emptyFn,explicitFields:[],modelNames:["userstory","defect"],whiteListFields:[]},initComponent:function(){this.callParent(arguments),this.mixins.field.initField.call(this),this.add([{xtype:"rallycheckboxfield",name:"showRows",boxLabel:"",margin:"0",submitValue:!1,value:this.getValue().showRows,listeners:{change:function(checkbox,checked){this.down("rallycombobox").setDisabled(!checked)},scope:this}},{xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],name:"rowsField",margin:"0 6px",width:130,emptyText:"Choose Field...",displayField:"name",valueField:"value",disabled:"true"!==this.getValue().showRows,editable:!1,submitValue:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[]}}]),this._loadModels()},_loadModels:function(){Rally.data.ModelFactory.getModels({types:this.getModelNames(),context:this.context,success:this._onModelsRetrieved,scope:this})},_onModelsRetrieved:function(models){var fields=_.uniq(Ext.Array.merge(this.explicitFields,this._getRowableFields(_.values(models))),"name"),combobox=this.down("rallycombobox");combobox.getStore().loadData(_.sortBy(fields,"name")),combobox.setValue(this.getValue().rowsField),this.fireEvent("ready",this)},_getRowableFields:function(models){var artifactModel=Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(models,this.context),allFields=artifactModel.getFields(),rowableFields=_.filter(allFields,function(field){var attr=field.attributeDefinition;return attr&&!attr.Hidden&&attr.Sortable&&(artifactModel.getModelsForField(field).length===models.length&&this.isAllowedFieldFn(field)||_.contains(this.whiteListFields,field.displayName))},this);return _.map(rowableFields,function(field){return{name:field.displayName,value:field.name}})},getSubmitData:function(){var data={},showField=this.down("rallycheckboxfield"),rowsField=this.down("rallycombobox"),showRows=showField.getValue()&&!_.isEmpty(rowsField.getValue());return data[showField.name]=showRows,showRows&&(data[rowsField.name]=rowsField.getValue()),data},refreshWithNewModelType:function(type){this.setModelNames([type]),this._loadModels()}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.board.Settings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.TextField","Rally.ui.NumberField","Rally.apps.common.RowSettingsField","Rally.data.wsapi.Filter"],getFields:function(context){return[{name:"type",xtype:"rallycombobox",shouldRespondToScopeChange:!0,context:context,storeConfig:{model:Ext.identityFn("TypeDefinition"),sorters:[{property:"Name"}],fetch:["DisplayName","ElementName","TypePath","Parent"],filters:[{property:"Creatable",value:!0}],autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{select:function(combo,records){combo.fireEvent("typeselected",records[0].get("TypePath"),combo.context)},ready:function(combo){combo.store.sort("DisplayName"),combo.store.filterBy(function(record){var parent=record.get("Parent"),parentName=parent.ElementName;return _.contains(["Artifact","SchedulableArtifact","Requirement","PortfolioItem"],parentName)}),combo.fireEvent("typeselected",combo.getRecord().get("TypePath"),combo.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(context){this.refreshWithNewContext(context)}}},{name:"groupByField",fieldLabel:"Columns",xtype:"rallyfieldcombobox",readyEvent:"ready",handlesEvents:{typeselected:function(type,context){this.refreshWithNewModelType(type,context)}},listeners:{ready:function(combo){combo.store.filterBy(function(record){var field=record.get("fieldDefinition"),attr=field.attributeDefinition;return!(!attr||attr.ReadOnly||attr.Hidden||!attr.Constrained||"COLLECTION"===attr.AttributeType||attr.AllowedValueType&&"User"===attr.AllowedValueType._refObjectName||_.contains(["Iteration","Release","Project"],attr.Name)||field.isMappedFromArtifact)});var fields=Ext.Array.map(combo.store.getRange(),function(record){return record.get(combo.getValueField())});Ext.Array.contains(fields,combo.getValue())||combo.setValue(fields[0])}}},{name:"groupHorizontallyByField",xtype:"rowsettingsfield",fieldLabel:"Swimlanes",mapsToMultiplePreferenceKeys:["showRows","rowsField"],readyEvent:"ready",isAllowedFieldFn:function(field){var attr=field.attributeDefinition;return(attr.Custom&&(attr.Constrained||"string"!==attr.AttributeType.toLowerCase())||attr.Constrained||_.contains(["quantity","boolean"],attr.AttributeType.toLowerCase())||!attr.Constrained&&"object"===attr.AttributeType.toLowerCase())&&!_.contains(["web_link","text","date"],attr.AttributeType.toLowerCase())&&!_.contains(["PortfolioItemType","LastResult"],attr.ElementName)},handlesEvents:{typeselected:function(type,context){this.refreshWithNewModelType(type,context)}}},{name:"order",fieldLabel:"Order",xtype:"rallyfieldcombobox",readyEvent:"ready",handlesEvents:{typeselected:function(type,context){this.refreshWithNewModelType(type,context)}},listeners:{ready:function(combo){combo.store.filterBy(function(record){var field=record.get("fieldDefinition"),attr=field.attributeDefinition;return attr&&attr.Sortable&&!field.isMappedFromArtifact})}},initialValue:context.getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled?"DragAndDropRank":"Rank"},{type:"query"}]}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.board.BoardApp",{extend:"Rally.app.App",alias:"widget.boardapp",requires:["Rally.ui.cardboard.plugin.FixedHeader","Rally.ui.gridboard.GridBoard","Rally.ui.gridboard.plugin.GridBoardAddNew","Rally.ui.gridboard.plugin.GridBoardCustomFilterControl","Rally.ui.gridboard.plugin.GridBoardFieldPicker","Rally.data.util.Sorter","Rally.apps.board.Settings","Rally.clientmetrics.ClientMetricsRecordable"],mixins:["Rally.clientmetrics.ClientMetricsRecordable","Rally.Messageable"],helpId:287,cls:"customboard",autoScroll:!1,layout:"fit",config:{defaultSettings:{type:"HierarchicalRequirement",groupByField:"ScheduleState",showRows:!1,eventType:"None"}},_otherBoardCardClick:function(card){this.filterToParent=card,this._addBoard()},launch:function(){this.filterToParent=null,"Receive"==this.getSetting("eventType")&&this.subscribe(this,"cardClick",this._otherBoardCardClick,this),Rally.data.ModelFactory.getModel({type:this.getSetting("type"),context:this.getContext().getDataContext()}).then({success:function(model){this.model=model,this.add(this._getGridBoardConfig())},scope:this})},_getGridBoardConfig:function(){var context=this.getContext(),modelNames=[this.getSetting("type")],config={xtype:"rallygridboard",stateful:!1,toggleState:"board",cardBoardConfig:this._getBoardConfig(),plugins:[{ptype:"rallygridboardaddnew",addNewControlConfig:{stateful:!0,stateId:context.getScopedStateId("board-add-new")}},{ptype:"rallygridboardcustomfiltercontrol",filterChildren:!1,filterControlConfig:{margin:"3 9 3 30",modelNames:modelNames,stateful:!0,stateId:context.getScopedStateId("board-custom-filter-button")},showOwnerFilter:!0,ownerFilterControlConfig:{stateful:!0,stateId:context.getScopedStateId("board-owner-filter")}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",boardFieldBlackList:["Successors","Predecessors","DisplayColor"],modelNames:modelNames}],context:context,modelNames:modelNames,storeConfig:{filters:this._getFilters()},listeners:{load:this._onLoad,scope:this}};return this.getEl()&&(config.height=this.getHeight()),config},_onLoad:function(){this.recordComponentReady({miscData:{type:this.getSetting("type"),columns:this.getSetting("groupByField"),rows:this.getSetting("showRows")&&this.getSetting("rowsField")||""}})},_getBoardConfig:function(){var that=this,boardConfig={margin:"10px 0 0 0",attribute:this.getSetting("groupByField"),context:this.getContext(),cardConfig:{editable:!0,showIconMenus:!0},loadMask:!0,plugins:[{ptype:"rallyfixedheadercardboard"}],storeConfig:{sorters:Rally.data.util.Sorter.sorters(this.getSetting("order"))},columnConfig:{fields:this.getSetting("fields")&&this.getSetting("fields").split(",")||[]}};return this.getSetting("showRows")&&Ext.merge(boardConfig,{rowConfig:{field:this.getSetting("rowsField"),sortDirection:"ASC"}}),this._shouldDisableRanking()&&(boardConfig.enableRanking=!1,boardConfig.enableCrossColumnRanking=!1,boardConfig.cardConfig.showRankMenuItems=!1),"Send"==this.getSetting("eventType")&&Ext.merge(boardConfig,{cardConfig:{xtype:"filteredcard",listeners:{cardclick:{fn:function(a,b,c){this.publish("cardClick",b)},scope:this}}}}),boardConfig},getSettingsFields:function(){var eventsStore=new Ext.data.ArrayStore({fields:["event"],data:[["None"],["Send"],["Receive"]]});return Rally.apps.board.Settings.getFields(this.getContext()).concat([{name:"eventType",xtype:"combo",store:eventsStore,valueField:"event",displayField:"event",queryMode:"local",forceSelection:!0,fieldLabel:"Events"}])},_shouldDisableRanking:function(){return"task"===this.getSetting("type").toLowerCase()&&(!this.getSetting("showRows")||this.getSetting("showRows")&&"workproduct"!==this.getSetting("rowsField").toLowerCase())},_addBoard:function(){var gridBoard=this.down("rallygridboard");gridBoard&&gridBoard.destroy(),this.add(this._getGridBoardConfig())},onTimeboxScopeChange:function(timeboxScope){this.callParent(arguments),this._addBoard()},_getFilters:function(){var queries=[],timeboxScope=this.getContext().getTimeboxScope();if(this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),timeboxScope&&timeboxScope.isApplicable(this.model)&&queries.push(timeboxScope.getQueryFilter()),!_.isNull(this.filterToParent)){var field=null,boardType=this.getSetting("type").toLowerCase().split("/")[0];switch(boardType){case"task":field="WorkProduct";break;case"hierarchicalrequirement":field="Feature";break;case"portfolioitem":field="Parent";break;case"testcase":field="WorkProduct";break;case"defect":field="Requirement";break;default:field="Parent"}var filter=Ext.create("Rally.data.wsapi.Filter",{property:field,operator:"=",value:this.filterToParent.get("_ref")});queries.push(filter)}return queries}})})();
                Ext.define("FilteredCard",{extend:"Rally.ui.cardboard.Card",alias:"widget.filteredcard",afterRender:function(){this.callParent(arguments),this.getEl().on("click",this._onCardClick,this)},_onCardClick:function(){this.fireEvent("cardclick",this,this.getRecord())}});

            Rally.launchApp('Rally.apps.board.BoardApp', {
                name:"Custom Board",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .customboard{overflow-y:hidden}
    </style>
</head>
<body>
</body>
</html>
